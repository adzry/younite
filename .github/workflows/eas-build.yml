name: EAS Build & Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: EAS Build (Preview Android)
        run: npx eas build --platform android --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Deploy to Railway
        run: |
          npm install -g railway
          railway up --ci
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for API to be Live
        run: sleep 20

      - name: Health Check with Retries (Root + /health)
        run: |
          for i in {1..5}; do
            echo "Attempt $i: Checking API endpoints..."
            ROOT=$(curl -s -o /dev/null -w "%{http_code}" https://younite-api.up.railway.app/)
            HEALTH=$(curl -s -o /dev/null -w "%{http_code}" https://younite-api.up.railway.app/health)

            if [ "$ROOT" = "200" ] && [ "$HEALTH" = "200" ]; then
              echo "✅ Both root (/) and /health endpoints are OK"
              exit 0
            fi

            echo "⚠️ API not ready (root=$ROOT, health=$HEALTH), retrying in 10s..."
            sleep 10
          done
          echo "❌ API did not pass health checks after 5 attempts"
          exit 1
